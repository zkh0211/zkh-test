'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _slatePropTypes = require('slate-prop-types');

var _slatePropTypes2 = _interopRequireDefault(_slatePropTypes);

var _offsetKey = require('../utils/offset-key');

var _offsetKey2 = _interopRequireDefault(_offsetKey);

var _environment = require('../constants/environment');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

/**
 * Debugger.
 *
 * @type {Function}
 */

var debug = (0, _debug2.default)('slate:leaves');

/**
 * Leaves.
 *
 * @type {Component}
 */

var Leaves = function (_React$Component) {
  _inherits(Leaves, _React$Component);

  function Leaves() {
    var _ref;

    var _temp, _this, _ret;

    _classCallCheck(this, Leaves);

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    return _ret = (_temp = (_this = _possibleConstructorReturn(this, (_ref = Leaves.__proto__ || Object.getPrototypeOf(Leaves)).call.apply(_ref, [this].concat(args))), _this), _initialiseProps.call(_this), _temp), _possibleConstructorReturn(_this, _ret);
  }

  /**
   * Property types.
   *
   * @type {Object}
   */

  /**
   * Debug.
   *
   * @param {String} message
   * @param {Mixed} ...args
   */

  _createClass(Leaves, [{
    key: 'shouldComponentUpdate',


    /**
     * Should component update?
     *
     * @param {Object} props
     * @return {Boolean}
     */

    value: function shouldComponentUpdate(props) {
      // If any of the regular properties have changed, re-render.
      if (props.index != this.props.index || props.marks != this.props.marks || props.schema != this.props.schema || props.text != this.props.text || props.parent != this.props.parent) {
        return true;
      }

      // Otherwise, don't update.
      return false;
    }

    /**
     * Render the leaf.
     *
     * @return {Element}
     */

  }, {
    key: 'render',
    value: function render() {
      var props = this.props;
      var node = props.node,
          index = props.index;

      var offsetKey = _offsetKey2.default.stringify({
        key: node.key,
        index: index
      });

      this.debug('render', { props: props });

      return _react2.default.createElement(
        'span',
        { 'data-offset-key': offsetKey },
        this.renderMarks(props)
      );
    }

    /**
     * Render all of the leaf's mark components.
     *
     * @param {Object} props
     * @return {Element}
     */

  }, {
    key: 'renderMarks',
    value: function renderMarks(props) {
      var marks = props.marks,
          schema = props.schema,
          node = props.node,
          offset = props.offset,
          text = props.text,
          state = props.state,
          editor = props.editor;

      var children = this.renderText(props);

      return marks.reduce(function (memo, mark) {
        var Component = mark.getComponent(schema);
        if (!Component) return memo;
        return _react2.default.createElement(
          Component,
          {
            editor: editor,
            mark: mark,
            marks: marks,
            node: node,
            offset: offset,
            schema: schema,
            state: state,
            text: text
          },
          memo
        );
      }, children);
    }

    /**
     * Render the text content of the leaf, accounting for browsers.
     *
     * @param {Object} props
     * @return {Element}
     */

  }, {
    key: 'renderText',
    value: function renderText(props) {
      var block = props.block,
          node = props.node,
          parent = props.parent,
          text = props.text,
          index = props.index,
          leaves = props.leaves;

      // COMPAT: If the text is empty and it's the only child, we need to render a
      // <br/> to get the block to have the proper height.

      if (text == '' && parent.kind == 'block' && parent.text == '') return _react2.default.createElement('br', null);

      // COMPAT: If the text is empty otherwise, it's because it's on the edge of
      // an inline void node, so we render a zero-width space so that the
      // selection can be inserted next to it still.
      if (text == '') {
        // COMPAT: In Chrome, zero-width space produces graphics glitches, so use
        // hair space in place of it. (2017/02/12)
        var space = _environment.IS_FIREFOX ? '\u200B' : '\u200A';
        return _react2.default.createElement(
          'span',
          { 'data-slate-zero-width': true },
          space
        );
      }

      // COMPAT: Browsers will collapse trailing new lines at the end of blocks,
      // so we need to add an extra trailing new lines to prevent that.
      var lastText = block.getLastText();
      var lastChar = text.charAt(text.length - 1);
      var isLastText = node == lastText;
      var isLastLeaf = index == leaves.size - 1;
      if (isLastText && isLastLeaf && lastChar == '\n') return text + '\n';

      // Otherwise, just return the text.
      return text;
    }
  }]);

  return Leaves;
}(_react2.default.Component);

/**
 * Export.
 *
 * @type {Component}
 */

Leaves.propTypes = {
  block: _slatePropTypes2.default.block.isRequired,
  editor: _propTypes2.default.object.isRequired,
  index: _propTypes2.default.number.isRequired,
  leaves: _slatePropTypes2.default.leaves.isRequired,
  marks: _slatePropTypes2.default.marks.isRequired,
  node: _slatePropTypes2.default.node.isRequired,
  offset: _propTypes2.default.number.isRequired,
  parent: _slatePropTypes2.default.node.isRequired,
  schema: _slatePropTypes2.default.schema.isRequired,
  state: _slatePropTypes2.default.state.isRequired,
  text: _propTypes2.default.string.isRequired
};

var _initialiseProps = function _initialiseProps() {
  var _this2 = this;

  this.debug = function (message) {
    for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
      args[_key2 - 1] = arguments[_key2];
    }

    debug.apply(undefined, [message, _this2.props.node.key + '-' + _this2.props.index].concat(args));
  };
};

exports.default = Leaves;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb25lbnRzL2xlYXZlcy5qcyJdLCJuYW1lcyI6WyJkZWJ1ZyIsIkxlYXZlcyIsInByb3BzIiwiaW5kZXgiLCJtYXJrcyIsInNjaGVtYSIsInRleHQiLCJwYXJlbnQiLCJub2RlIiwib2Zmc2V0S2V5Iiwic3RyaW5naWZ5Iiwia2V5IiwicmVuZGVyTWFya3MiLCJvZmZzZXQiLCJzdGF0ZSIsImVkaXRvciIsImNoaWxkcmVuIiwicmVuZGVyVGV4dCIsInJlZHVjZSIsIm1lbW8iLCJtYXJrIiwiQ29tcG9uZW50IiwiZ2V0Q29tcG9uZW50IiwiYmxvY2siLCJsZWF2ZXMiLCJraW5kIiwic3BhY2UiLCJsYXN0VGV4dCIsImdldExhc3RUZXh0IiwibGFzdENoYXIiLCJjaGFyQXQiLCJsZW5ndGgiLCJpc0xhc3RUZXh0IiwiaXNMYXN0TGVhZiIsInNpemUiLCJwcm9wVHlwZXMiLCJpc1JlcXVpcmVkIiwib2JqZWN0IiwibnVtYmVyIiwic3RyaW5nIiwibWVzc2FnZSIsImFyZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7Ozs7Ozs7O0FBRUE7Ozs7OztBQU1BLElBQU1BLFFBQVEscUJBQU0sY0FBTixDQUFkOztBQUVBOzs7Ozs7SUFNTUMsTTs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFSjs7Ozs7O0FBb0JBOzs7Ozs7Ozs7OztBQVdBOzs7Ozs7OzBDQU9zQkMsSyxFQUFPO0FBQzNCO0FBQ0EsVUFDRUEsTUFBTUMsS0FBTixJQUFlLEtBQUtELEtBQUwsQ0FBV0MsS0FBMUIsSUFDQUQsTUFBTUUsS0FBTixJQUFlLEtBQUtGLEtBQUwsQ0FBV0UsS0FEMUIsSUFFQUYsTUFBTUcsTUFBTixJQUFnQixLQUFLSCxLQUFMLENBQVdHLE1BRjNCLElBR0FILE1BQU1JLElBQU4sSUFBYyxLQUFLSixLQUFMLENBQVdJLElBSHpCLElBSUFKLE1BQU1LLE1BQU4sSUFBZ0IsS0FBS0wsS0FBTCxDQUFXSyxNQUw3QixFQU1FO0FBQ0EsZUFBTyxJQUFQO0FBQ0Q7O0FBRUQ7QUFDQSxhQUFPLEtBQVA7QUFDRDs7QUFFRDs7Ozs7Ozs7NkJBTVM7QUFBQSxVQUNDTCxLQURELEdBQ1csSUFEWCxDQUNDQSxLQUREO0FBQUEsVUFFQ00sSUFGRCxHQUVpQk4sS0FGakIsQ0FFQ00sSUFGRDtBQUFBLFVBRU9MLEtBRlAsR0FFaUJELEtBRmpCLENBRU9DLEtBRlA7O0FBR1AsVUFBTU0sWUFBWSxvQkFBVUMsU0FBVixDQUFvQjtBQUNwQ0MsYUFBS0gsS0FBS0csR0FEMEI7QUFFcENSO0FBRm9DLE9BQXBCLENBQWxCOztBQUtBLFdBQUtILEtBQUwsQ0FBVyxRQUFYLEVBQXFCLEVBQUVFLFlBQUYsRUFBckI7O0FBRUEsYUFDRTtBQUFBO0FBQUEsVUFBTSxtQkFBaUJPLFNBQXZCO0FBQ0csYUFBS0csV0FBTCxDQUFpQlYsS0FBakI7QUFESCxPQURGO0FBS0Q7O0FBRUQ7Ozs7Ozs7OztnQ0FPWUEsSyxFQUFPO0FBQUEsVUFDVEUsS0FEUyxHQUM0Q0YsS0FENUMsQ0FDVEUsS0FEUztBQUFBLFVBQ0ZDLE1BREUsR0FDNENILEtBRDVDLENBQ0ZHLE1BREU7QUFBQSxVQUNNRyxJQUROLEdBQzRDTixLQUQ1QyxDQUNNTSxJQUROO0FBQUEsVUFDWUssTUFEWixHQUM0Q1gsS0FENUMsQ0FDWVcsTUFEWjtBQUFBLFVBQ29CUCxJQURwQixHQUM0Q0osS0FENUMsQ0FDb0JJLElBRHBCO0FBQUEsVUFDMEJRLEtBRDFCLEdBQzRDWixLQUQ1QyxDQUMwQlksS0FEMUI7QUFBQSxVQUNpQ0MsTUFEakMsR0FDNENiLEtBRDVDLENBQ2lDYSxNQURqQzs7QUFFakIsVUFBTUMsV0FBVyxLQUFLQyxVQUFMLENBQWdCZixLQUFoQixDQUFqQjs7QUFFQSxhQUFPRSxNQUFNYyxNQUFOLENBQWEsVUFBQ0MsSUFBRCxFQUFPQyxJQUFQLEVBQWdCO0FBQ2xDLFlBQU1DLFlBQVlELEtBQUtFLFlBQUwsQ0FBa0JqQixNQUFsQixDQUFsQjtBQUNBLFlBQUksQ0FBQ2dCLFNBQUwsRUFBZ0IsT0FBT0YsSUFBUDtBQUNoQixlQUNFO0FBQUMsbUJBQUQ7QUFBQTtBQUNFLG9CQUFRSixNQURWO0FBRUUsa0JBQU1LLElBRlI7QUFHRSxtQkFBT2hCLEtBSFQ7QUFJRSxrQkFBTUksSUFKUjtBQUtFLG9CQUFRSyxNQUxWO0FBTUUsb0JBQVFSLE1BTlY7QUFPRSxtQkFBT1MsS0FQVDtBQVFFLGtCQUFNUjtBQVJSO0FBVUdhO0FBVkgsU0FERjtBQWNELE9BakJNLEVBaUJKSCxRQWpCSSxDQUFQO0FBa0JEOztBQUVEOzs7Ozs7Ozs7K0JBT1dkLEssRUFBTztBQUFBLFVBQ1JxQixLQURRLEdBQ3FDckIsS0FEckMsQ0FDUnFCLEtBRFE7QUFBQSxVQUNEZixJQURDLEdBQ3FDTixLQURyQyxDQUNETSxJQURDO0FBQUEsVUFDS0QsTUFETCxHQUNxQ0wsS0FEckMsQ0FDS0ssTUFETDtBQUFBLFVBQ2FELElBRGIsR0FDcUNKLEtBRHJDLENBQ2FJLElBRGI7QUFBQSxVQUNtQkgsS0FEbkIsR0FDcUNELEtBRHJDLENBQ21CQyxLQURuQjtBQUFBLFVBQzBCcUIsTUFEMUIsR0FDcUN0QixLQURyQyxDQUMwQnNCLE1BRDFCOztBQUdoQjtBQUNBOztBQUNBLFVBQUlsQixRQUFRLEVBQVIsSUFBY0MsT0FBT2tCLElBQVAsSUFBZSxPQUE3QixJQUF3Q2xCLE9BQU9ELElBQVAsSUFBZSxFQUEzRCxFQUErRCxPQUFPLHlDQUFQOztBQUUvRDtBQUNBO0FBQ0E7QUFDQSxVQUFJQSxRQUFRLEVBQVosRUFBZ0I7QUFDZDtBQUNBO0FBQ0EsWUFBTW9CLFFBQVEsMEJBQWEsUUFBYixHQUF3QixRQUF0QztBQUNBLGVBQU87QUFBQTtBQUFBLFlBQU0sNkJBQU47QUFBNkJBO0FBQTdCLFNBQVA7QUFDRDs7QUFFRDtBQUNBO0FBQ0EsVUFBTUMsV0FBV0osTUFBTUssV0FBTixFQUFqQjtBQUNBLFVBQU1DLFdBQVd2QixLQUFLd0IsTUFBTCxDQUFZeEIsS0FBS3lCLE1BQUwsR0FBYyxDQUExQixDQUFqQjtBQUNBLFVBQU1DLGFBQWF4QixRQUFRbUIsUUFBM0I7QUFDQSxVQUFNTSxhQUFhOUIsU0FBU3FCLE9BQU9VLElBQVAsR0FBYyxDQUExQztBQUNBLFVBQUlGLGNBQWNDLFVBQWQsSUFBNEJKLFlBQVksSUFBNUMsRUFBa0QsT0FBVXZCLElBQVY7O0FBRWxEO0FBQ0EsYUFBT0EsSUFBUDtBQUNEOzs7O0VBaEprQixnQkFBTWUsUzs7QUFvSjNCOzs7Ozs7QUFwSk1wQixNLENBUUdrQyxTLEdBQVk7QUFDakJaLFNBQU8seUJBQVdBLEtBQVgsQ0FBaUJhLFVBRFA7QUFFakJyQixVQUFRLG9CQUFNc0IsTUFBTixDQUFhRCxVQUZKO0FBR2pCakMsU0FBTyxvQkFBTW1DLE1BQU4sQ0FBYUYsVUFISDtBQUlqQlosVUFBUSx5QkFBV0EsTUFBWCxDQUFrQlksVUFKVDtBQUtqQmhDLFNBQU8seUJBQVdBLEtBQVgsQ0FBaUJnQyxVQUxQO0FBTWpCNUIsUUFBTSx5QkFBV0EsSUFBWCxDQUFnQjRCLFVBTkw7QUFPakJ2QixVQUFRLG9CQUFNeUIsTUFBTixDQUFhRixVQVBKO0FBUWpCN0IsVUFBUSx5QkFBV0MsSUFBWCxDQUFnQjRCLFVBUlA7QUFTakIvQixVQUFRLHlCQUFXQSxNQUFYLENBQWtCK0IsVUFUVDtBQVVqQnRCLFNBQU8seUJBQVdBLEtBQVgsQ0FBaUJzQixVQVZQO0FBV2pCOUIsUUFBTSxvQkFBTWlDLE1BQU4sQ0FBYUg7QUFYRixDOzs7OztPQXFCbkJwQyxLLEdBQVEsVUFBQ3dDLE9BQUQsRUFBc0I7QUFBQSx1Q0FBVEMsSUFBUztBQUFUQSxVQUFTO0FBQUE7O0FBQzVCekMsNEJBQU13QyxPQUFOLEVBQWtCLE9BQUt0QyxLQUFMLENBQVdNLElBQVgsQ0FBZ0JHLEdBQWxDLFNBQXlDLE9BQUtULEtBQUwsQ0FBV0MsS0FBcEQsU0FBZ0VzQyxJQUFoRTtBQUNELEc7OztrQkEySFl4QyxNIiwiZmlsZSI6ImxlYXZlcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJ1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgU2xhdGVUeXBlcyBmcm9tICdzbGF0ZS1wcm9wLXR5cGVzJ1xuXG5pbXBvcnQgT2Zmc2V0S2V5IGZyb20gJy4uL3V0aWxzL29mZnNldC1rZXknXG5pbXBvcnQgeyBJU19GSVJFRk9YIH0gZnJvbSAnLi4vY29uc3RhbnRzL2Vudmlyb25tZW50J1xuXG4vKipcbiAqIERlYnVnZ2VyLlxuICpcbiAqIEB0eXBlIHtGdW5jdGlvbn1cbiAqL1xuXG5jb25zdCBkZWJ1ZyA9IERlYnVnKCdzbGF0ZTpsZWF2ZXMnKVxuXG4vKipcbiAqIExlYXZlcy5cbiAqXG4gKiBAdHlwZSB7Q29tcG9uZW50fVxuICovXG5cbmNsYXNzIExlYXZlcyBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG5cbiAgLyoqXG4gICAqIFByb3BlcnR5IHR5cGVzLlxuICAgKlxuICAgKiBAdHlwZSB7T2JqZWN0fVxuICAgKi9cblxuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIGJsb2NrOiBTbGF0ZVR5cGVzLmJsb2NrLmlzUmVxdWlyZWQsXG4gICAgZWRpdG9yOiBUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBpbmRleDogVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG4gICAgbGVhdmVzOiBTbGF0ZVR5cGVzLmxlYXZlcy5pc1JlcXVpcmVkLFxuICAgIG1hcmtzOiBTbGF0ZVR5cGVzLm1hcmtzLmlzUmVxdWlyZWQsXG4gICAgbm9kZTogU2xhdGVUeXBlcy5ub2RlLmlzUmVxdWlyZWQsXG4gICAgb2Zmc2V0OiBUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCxcbiAgICBwYXJlbnQ6IFNsYXRlVHlwZXMubm9kZS5pc1JlcXVpcmVkLFxuICAgIHNjaGVtYTogU2xhdGVUeXBlcy5zY2hlbWEuaXNSZXF1aXJlZCxcbiAgICBzdGF0ZTogU2xhdGVUeXBlcy5zdGF0ZS5pc1JlcXVpcmVkLFxuICAgIHRleHQ6IFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICB9XG5cbiAgLyoqXG4gICAqIERlYnVnLlxuICAgKlxuICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZVxuICAgKiBAcGFyYW0ge01peGVkfSAuLi5hcmdzXG4gICAqL1xuXG4gIGRlYnVnID0gKG1lc3NhZ2UsIC4uLmFyZ3MpID0+IHtcbiAgICBkZWJ1ZyhtZXNzYWdlLCBgJHt0aGlzLnByb3BzLm5vZGUua2V5fS0ke3RoaXMucHJvcHMuaW5kZXh9YCwgLi4uYXJncylcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG91bGQgY29tcG9uZW50IHVwZGF0ZT9cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHByb3BzXG4gICAqIEByZXR1cm4ge0Jvb2xlYW59XG4gICAqL1xuXG4gIHNob3VsZENvbXBvbmVudFVwZGF0ZShwcm9wcykge1xuICAgIC8vIElmIGFueSBvZiB0aGUgcmVndWxhciBwcm9wZXJ0aWVzIGhhdmUgY2hhbmdlZCwgcmUtcmVuZGVyLlxuICAgIGlmIChcbiAgICAgIHByb3BzLmluZGV4ICE9IHRoaXMucHJvcHMuaW5kZXggfHxcbiAgICAgIHByb3BzLm1hcmtzICE9IHRoaXMucHJvcHMubWFya3MgfHxcbiAgICAgIHByb3BzLnNjaGVtYSAhPSB0aGlzLnByb3BzLnNjaGVtYSB8fFxuICAgICAgcHJvcHMudGV4dCAhPSB0aGlzLnByb3BzLnRleHQgfHxcbiAgICAgIHByb3BzLnBhcmVudCAhPSB0aGlzLnByb3BzLnBhcmVudFxuICAgICkge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG5cbiAgICAvLyBPdGhlcndpc2UsIGRvbid0IHVwZGF0ZS5cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW5kZXIgdGhlIGxlYWYuXG4gICAqXG4gICAqIEByZXR1cm4ge0VsZW1lbnR9XG4gICAqL1xuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IHByb3BzIH0gPSB0aGlzXG4gICAgY29uc3QgeyBub2RlLCBpbmRleCB9ID0gcHJvcHNcbiAgICBjb25zdCBvZmZzZXRLZXkgPSBPZmZzZXRLZXkuc3RyaW5naWZ5KHtcbiAgICAgIGtleTogbm9kZS5rZXksXG4gICAgICBpbmRleFxuICAgIH0pXG5cbiAgICB0aGlzLmRlYnVnKCdyZW5kZXInLCB7IHByb3BzIH0pXG5cbiAgICByZXR1cm4gKFxuICAgICAgPHNwYW4gZGF0YS1vZmZzZXQta2V5PXtvZmZzZXRLZXl9PlxuICAgICAgICB7dGhpcy5yZW5kZXJNYXJrcyhwcm9wcyl9XG4gICAgICA8L3NwYW4+XG4gICAgKVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbmRlciBhbGwgb2YgdGhlIGxlYWYncyBtYXJrIGNvbXBvbmVudHMuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wc1xuICAgKiBAcmV0dXJuIHtFbGVtZW50fVxuICAgKi9cblxuICByZW5kZXJNYXJrcyhwcm9wcykge1xuICAgIGNvbnN0IHsgbWFya3MsIHNjaGVtYSwgbm9kZSwgb2Zmc2V0LCB0ZXh0LCBzdGF0ZSwgZWRpdG9yIH0gPSBwcm9wc1xuICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5yZW5kZXJUZXh0KHByb3BzKVxuXG4gICAgcmV0dXJuIG1hcmtzLnJlZHVjZSgobWVtbywgbWFyaykgPT4ge1xuICAgICAgY29uc3QgQ29tcG9uZW50ID0gbWFyay5nZXRDb21wb25lbnQoc2NoZW1hKVxuICAgICAgaWYgKCFDb21wb25lbnQpIHJldHVybiBtZW1vXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8Q29tcG9uZW50XG4gICAgICAgICAgZWRpdG9yPXtlZGl0b3J9XG4gICAgICAgICAgbWFyaz17bWFya31cbiAgICAgICAgICBtYXJrcz17bWFya3N9XG4gICAgICAgICAgbm9kZT17bm9kZX1cbiAgICAgICAgICBvZmZzZXQ9e29mZnNldH1cbiAgICAgICAgICBzY2hlbWE9e3NjaGVtYX1cbiAgICAgICAgICBzdGF0ZT17c3RhdGV9XG4gICAgICAgICAgdGV4dD17dGV4dH1cbiAgICAgICAgPlxuICAgICAgICAgIHttZW1vfVxuICAgICAgICA8L0NvbXBvbmVudD5cbiAgICAgIClcbiAgICB9LCBjaGlsZHJlbilcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW5kZXIgdGhlIHRleHQgY29udGVudCBvZiB0aGUgbGVhZiwgYWNjb3VudGluZyBmb3IgYnJvd3NlcnMuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wc1xuICAgKiBAcmV0dXJuIHtFbGVtZW50fVxuICAgKi9cblxuICByZW5kZXJUZXh0KHByb3BzKSB7XG4gICAgY29uc3QgeyBibG9jaywgbm9kZSwgcGFyZW50LCB0ZXh0LCBpbmRleCwgbGVhdmVzIH0gPSBwcm9wc1xuXG4gICAgLy8gQ09NUEFUOiBJZiB0aGUgdGV4dCBpcyBlbXB0eSBhbmQgaXQncyB0aGUgb25seSBjaGlsZCwgd2UgbmVlZCB0byByZW5kZXIgYVxuICAgIC8vIDxici8+IHRvIGdldCB0aGUgYmxvY2sgdG8gaGF2ZSB0aGUgcHJvcGVyIGhlaWdodC5cbiAgICBpZiAodGV4dCA9PSAnJyAmJiBwYXJlbnQua2luZCA9PSAnYmxvY2snICYmIHBhcmVudC50ZXh0ID09ICcnKSByZXR1cm4gPGJyIC8+XG5cbiAgICAvLyBDT01QQVQ6IElmIHRoZSB0ZXh0IGlzIGVtcHR5IG90aGVyd2lzZSwgaXQncyBiZWNhdXNlIGl0J3Mgb24gdGhlIGVkZ2Ugb2ZcbiAgICAvLyBhbiBpbmxpbmUgdm9pZCBub2RlLCBzbyB3ZSByZW5kZXIgYSB6ZXJvLXdpZHRoIHNwYWNlIHNvIHRoYXQgdGhlXG4gICAgLy8gc2VsZWN0aW9uIGNhbiBiZSBpbnNlcnRlZCBuZXh0IHRvIGl0IHN0aWxsLlxuICAgIGlmICh0ZXh0ID09ICcnKSB7XG4gICAgICAvLyBDT01QQVQ6IEluIENocm9tZSwgemVyby13aWR0aCBzcGFjZSBwcm9kdWNlcyBncmFwaGljcyBnbGl0Y2hlcywgc28gdXNlXG4gICAgICAvLyBoYWlyIHNwYWNlIGluIHBsYWNlIG9mIGl0LiAoMjAxNy8wMi8xMilcbiAgICAgIGNvbnN0IHNwYWNlID0gSVNfRklSRUZPWCA/ICdcXHUyMDBCJyA6ICdcXHUyMDBBJ1xuICAgICAgcmV0dXJuIDxzcGFuIGRhdGEtc2xhdGUtemVyby13aWR0aD57c3BhY2V9PC9zcGFuPlxuICAgIH1cblxuICAgIC8vIENPTVBBVDogQnJvd3NlcnMgd2lsbCBjb2xsYXBzZSB0cmFpbGluZyBuZXcgbGluZXMgYXQgdGhlIGVuZCBvZiBibG9ja3MsXG4gICAgLy8gc28gd2UgbmVlZCB0byBhZGQgYW4gZXh0cmEgdHJhaWxpbmcgbmV3IGxpbmVzIHRvIHByZXZlbnQgdGhhdC5cbiAgICBjb25zdCBsYXN0VGV4dCA9IGJsb2NrLmdldExhc3RUZXh0KClcbiAgICBjb25zdCBsYXN0Q2hhciA9IHRleHQuY2hhckF0KHRleHQubGVuZ3RoIC0gMSlcbiAgICBjb25zdCBpc0xhc3RUZXh0ID0gbm9kZSA9PSBsYXN0VGV4dFxuICAgIGNvbnN0IGlzTGFzdExlYWYgPSBpbmRleCA9PSBsZWF2ZXMuc2l6ZSAtIDFcbiAgICBpZiAoaXNMYXN0VGV4dCAmJiBpc0xhc3RMZWFmICYmIGxhc3RDaGFyID09ICdcXG4nKSByZXR1cm4gYCR7dGV4dH1cXG5gXG5cbiAgICAvLyBPdGhlcndpc2UsIGp1c3QgcmV0dXJuIHRoZSB0ZXh0LlxuICAgIHJldHVybiB0ZXh0XG4gIH1cblxufVxuXG4vKipcbiAqIEV4cG9ydC5cbiAqXG4gKiBAdHlwZSB7Q29tcG9uZW50fVxuICovXG5cbmV4cG9ydCBkZWZhdWx0IExlYXZlc1xuIl19